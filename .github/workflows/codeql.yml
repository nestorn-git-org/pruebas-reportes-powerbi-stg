name: Code Analysis

on:
  push:
    branches: [main, develop, 'hotfix/**', 'release/**']
    paths: ['src/**', 'config/**', 'scripts/**', 'test/**', 'requirements.txt']
  pull_request:
    branches: [develop, main]
    paths: ['src/**', 'config/**', 'scripts/**', 'test/**', 'requirements.txt']

env:
  PYTHON_VERSION: '3.11'
  POWERSHELL_VERSION: '7.3'

jobs:
  detect-changes:
    name: Detect File Changes
    runs-on: ubuntu-latest
    outputs:
      python: ${{ steps.changes.outputs.python }}
      powershell: ${{ steps.changes.outputs.powershell }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: |
            python:
              - 'scripts/*.py'
              - 'requirements.txt'              
              - 'scripts/pyproject.toml'
            powershell:
              - 'scripts/*.ps1'
              - 'scripts/*.psm1'
              - 'scripts/*.psd1'

  code-analysis:
    name: ${{ matrix.language }} Analysis
    runs-on: ${{ matrix.os }}
    needs: detect-changes
    if: |
      always() && 
      ((matrix.language == 'python' && needs.detect-changes.outputs.python == 'true') ||
       (matrix.language == 'powershell' && needs.detect-changes.outputs.powershell == 'true'))
    
    strategy:
      fail-fast: false
      matrix:
        include:
          - language: python
            os: ubuntu-latest
            setup-action: setup-python
            version: ${{ env.PYTHON_VERSION }}
          - language: powershell
            os: windows-latest
            setup-action: setup-powershell
            version: ${{ env.POWERSHELL_VERSION }}

    permissions:
      actions: read
      contents: read
      security-events: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        if: matrix.language == 'python'
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.version }}
          cache: 'pip'

      - name: Setup PowerShell
        if: matrix.language == 'powershell'
        uses: actions/setup-powershell@v1
        with:
          powershell-version: ${{ matrix.version }}

      - name: Initialize CodeQL
        if: matrix.language == 'python'
        uses: github/codeql-action/init@v2
        with:
          languages: python
          queries: +security-and-quality

      - name: Install Python dependencies
        if: matrix.language == 'python'
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi

      - name: Install PSScriptAnalyzer
        if: matrix.language == 'powershell'
        shell: pwsh
        run: |
          Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser
          Install-Module -Name Pester -Force -Scope CurrentUser

      - name: Run CodeQL Analysis
        if: matrix.language == 'python'
        uses: github/codeql-action/analyze@v2
        with:
          category: "/language:python"

      - name: Run PSScriptAnalyzer
        if: matrix.language == 'powershell'
        shell: pwsh
        run: |
          $results = @()
          # Only analyze in the scripts directory
          Get-ChildItem -Path "scripts" -Recurse -Include "*.ps1", "*.psm1", "*.psd1" | ForEach-Object {
            $analysis = Invoke-ScriptAnalyzer -Path $_.FullName -Severity Error,Warning,Information
            $results += $analysis
          }
          
          # Convert to SARIF format
          $sarif = @{
            version = "2.1.0"
            runs = @(
              @{
                tool = @{
                  driver = @{
                    name = "PSScriptAnalyzer"
                    version = (Get-Module PSScriptAnalyzer).Version.ToString()
                  }
                }
                results = @()
              }
            )
          }
          
          foreach ($result in $results) {
            $sarifResult = @{
              ruleId = $result.RuleName
              level = switch ($result.Severity) {
                "Error" { "error" }
                "Warning" { "warning" }
                "Information" { "note" }
              }
              message = @{ text = $result.Message }
              locations = @(
                @{
                  physicalLocation = @{
                    artifactLocation = @{
                      uri = $result.ScriptPath
                    }
                    region = @{
                      startLine = $result.Line
                      startColumn = $result.Column
                    }
                  }
                }
              )
            }
            $sarif.runs[0].results += $sarifResult
          }
          
          $sarif | ConvertTo-Json -Depth 10 | Out-File -FilePath "psscriptanalyzer-results.sarif"

      - name: Upload PSScriptAnalyzer SARIF
        if: matrix.language == 'powershell'
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: psscriptanalyzer-results.sarif
          category: "PSScriptAnalyzer"

      - name: Upload analysis artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ${{ matrix.language }}-analysis-results
          path: |
            **/*.sarif
            **/codeql-results/
